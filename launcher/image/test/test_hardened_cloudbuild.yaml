substitutions:
  # Expects hardened image (not debug) and should have startup-script service
  # disabled. google-startup-scripts.service is only enabled with multi-user.target.
  '_IMAGE_NAME': 'confidential-space-51031c1-dev-hardened'
  '_BASE_IMAGE_PROJECT': 'confidential-space-images-dev'
  '_METADATA_FILE': 'startup-script=data/echo_startupscript.sh'
  '_CLEANUP': 'true'
steps:
- name: 'gcr.io/cloud-builders/gcloud'
  entrypoint: 'bash'
  env:
  - 'BUILD_ID=$BUILD_ID'
  args: ['create_vm.sh','-i', '${_IMAGE_NAME}',
          -p, '${_BASE_IMAGE_PROJECT}',
          -f, '${_METADATA_FILE}'
        ]
- name: 'gcr.io/cloud-builders/gcloud'
  entrypoint: 'bash'
  env:
  - 'BUILD_ID=$BUILD_ID'
  args: ['test_multiwriterpd_disabled.sh']
- name: 'gcr.io/cloud-builders/gcloud'
  entrypoint: 'bash'
  args: ['test_startupscript_disabled.sh']
- name: 'gcr.io/cloud-builders/gcloud'
  entrypoint: 'bash'
  env:
  - 'CLEANUP=$_CLEANUP'
  args: ['cleanup.sh']
# Must come after cleanup.
- name: 'gcr.io/cloud-builders/gcloud'
  entrypoint: 'bash'
  env:
  - 'BUILD_ID=$BUILD_ID'
  args: ['check_failure.sh']
