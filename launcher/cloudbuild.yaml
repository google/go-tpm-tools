substitutions:
  '_BASE_IMAGE': '' # If left empty, will use the latest image in _BASE_IMAGE_FAMILY of _BASE_IMAGE_PROJECT
  '_BASE_IMAGE_FAMILY': 'cos-125-lts'
  '_BASE_IMAGE_PROJECT': 'cos-cloud'
  '_OUTPUT_IMAGE_PREFIX': 'confidential-space'
  '_OUTPUT_IMAGE_SUFFIX': ''
  '_OUTPUT_IMAGE_FAMILY': ''
  '_BUCKET_NAME': '${PROJECT_ID}_cloudbuild'
  '_VG_BASE_IMAGE': 'cos-125-19216-220-9'

steps:
# determine the base image
- name: 'gcr.io/cloud-builders/gcloud'
  id: BaseImageIdent
  env:
  - 'BASE_IMAGE=$_BASE_IMAGE'
  - 'BASE_IMAGE_FAMILY=$_BASE_IMAGE_FAMILY'
  - 'BASE_IMAGE_PROJECT=$_BASE_IMAGE_PROJECT'
  script: |
    #!/usr/bin/env bash

    # if BASE_IMAGE is not specified in the substitutions, use the latest image of the image family
    base_image=${BASE_IMAGE}
    if [ -z ${base_image} ]
    then
      echo "getting the latest image from project:" ${BASE_IMAGE_PROJECT} "family: "${BASE_IMAGE_FAMILY}
      base_image=$(gcloud compute images describe-from-family ${BASE_IMAGE_FAMILY} --project ${BASE_IMAGE_PROJECT} | grep name | cut -d ' ' -f 2)
    fi

    echo "base image:" ${base_image} "project:" ${BASE_IMAGE_PROJECT} 
    echo ${base_image} > /workspace/base_image.txt

- name: golang:1.24
  id: LauncherCompile
  entrypoint: /bin/bash
  args:
    - -c
    - |
      # Install required build tools and Rust toolchain
      apt-get update && apt-get install -y cmake clang pkg-config libssl-dev build-essential
      curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y --default-toolchain stable
      source $$HOME/.cargo/env
      
      # Install bindgen-cli
      cargo install bindgen-cli
      
      # Build the Rust keymanager libraries
      cd keymanager
      cargo build --release
      cd ..
      
      # Build the launcher with CGO enabled
      cd launcher/launcher
      export CGO_LDFLAGS="-L/workspace/keymanager/target/release -L/workspace/keymanager/target/debug"
      CGO_ENABLED=1 go build -o ../image/launcher -ldflags="-X 'main.BuildCommit=${SHORT_SHA}' -extldflags '-static'"

- name: 'gcr.io/cloud-builders/gcloud'
  id: DownloadExpBinary
  entrypoint: 'gcloud'
  args: ['storage',
          'cp',
          'gs://confidential-space-images_third-party/confidential_space_experiments',
          './launcher/image/confidential_space_experiments']

- name: 'gcr.io/cloud-builders/gcloud'
  id: DebugVgImageBuild
  waitFor: ['BaseImageIdent', 'LauncherCompile', 'DownloadExpBinary']
  env:
  - 'OUTPUT_IMAGE_NAME=${_OUTPUT_IMAGE_PREFIX}-vg-debug-${_OUTPUT_IMAGE_SUFFIX}'
  - 'OUTPUT_IMAGE_FAMILY=${_OUTPUT_IMAGE_FAMILY}-vg'
  - 'BUCKET_NAME=$_BUCKET_NAME'
  - 'BASE_IMAGE_PROJECT=$_BASE_IMAGE_PROJECT'
  - 'VG_BASE_IMAGE=$_VG_BASE_IMAGE'
  script: |
    #!/usr/bin/env bash
    set -exuo pipefail

    echo "building the debug image: ${OUTPUT_IMAGE_NAME} with the base image: ${VG_BASE_IMAGE}"
    gcloud builds submit --config=launcher/image/cloudbuild.yaml \
    --region us-west1 \
    --substitutions \
    _BASE_IMAGE=${VG_BASE_IMAGE},\
    _BASE_IMAGE_PROJECT=${BASE_IMAGE_PROJECT},\
    _OUTPUT_IMAGE_FAMILY=${OUTPUT_IMAGE_FAMILY}-debug,\
    _OUTPUT_IMAGE_NAME=${OUTPUT_IMAGE_NAME},\
    _IMAGE_ENV=debug,\
    _CS_LICENSE=projects/confidential-space-images/global/licenses/confidential-space-debug,\
    _BUCKET_NAME=${BUCKET_NAME},\
    _PRELOAD_SCRIPT=vgpreload.sh
    exit

- name: 'gcr.io/cloud-builders/gcloud'
  id: HardenedVgImageBuild
  waitFor: ['BaseImageIdent', 'LauncherCompile', 'DownloadExpBinary']
  env:
  - 'OUTPUT_IMAGE_NAME=${_OUTPUT_IMAGE_PREFIX}-vg-hardened-${_OUTPUT_IMAGE_SUFFIX}'
  - 'OUTPUT_IMAGE_FAMILY=${_OUTPUT_IMAGE_FAMILY}-vg'
  - 'BUCKET_NAME=$_BUCKET_NAME'
  - 'SHORT_SHA=${SHORT_SHA}'
  - 'BASE_IMAGE_PROJECT=$_BASE_IMAGE_PROJECT'
  - 'VG_BASE_IMAGE=$_VG_BASE_IMAGE'
  script: |
    #!/usr/bin/env bash
    set -exuo pipefail

    echo "building the hardened image: ${OUTPUT_IMAGE_NAME} with the base image: ${VG_BASE_IMAGE}"
    gcloud builds submit --config=launcher/image/cloudbuild.yaml \
    --region us-west1 \
    --substitutions \
    _BASE_IMAGE=${VG_BASE_IMAGE},\
    _BASE_IMAGE_PROJECT=${BASE_IMAGE_PROJECT},\
    _OUTPUT_IMAGE_FAMILY=${OUTPUT_IMAGE_FAMILY},\
    _OUTPUT_IMAGE_NAME=${OUTPUT_IMAGE_NAME},\
    _IMAGE_ENV=hardened,\
    _CS_LICENSE=projects/confidential-space-images/global/licenses/confidential-space,\
    _BUCKET_NAME=${BUCKET_NAME},\
    _PRELOAD_SCRIPT=vgpreload.sh
    exit

- name: 'gcr.io/cloud-builders/gcloud'
  id: DebugImageBuild
  waitFor: ['BaseImageIdent', 'LauncherCompile', 'DownloadExpBinary']
  env:
  - 'OUTPUT_IMAGE_NAME=${_OUTPUT_IMAGE_PREFIX}-debug-${_OUTPUT_IMAGE_SUFFIX}'
  - 'OUTPUT_IMAGE_FAMILY=${_OUTPUT_IMAGE_FAMILY}'
  - 'BUCKET_NAME=$_BUCKET_NAME'
  - 'BASE_IMAGE_PROJECT=$_BASE_IMAGE_PROJECT'
  script: |
    #!/usr/bin/env bash
    set -exuo pipefail

    base_image=$(cat /workspace/base_image.txt)
    echo "building the debug image: ${OUTPUT_IMAGE_NAME} with the base image: ${base_image}"
    gcloud builds submit --config=launcher/image/cloudbuild.yaml \
    --region us-west1 \
    --substitutions \
    _BASE_IMAGE=${base_image},\
    _BASE_IMAGE_PROJECT=${BASE_IMAGE_PROJECT},\
    _OUTPUT_IMAGE_FAMILY=${OUTPUT_IMAGE_FAMILY}-debug,\
    _OUTPUT_IMAGE_NAME=${OUTPUT_IMAGE_NAME},\
    _IMAGE_ENV=debug,\
    _CS_LICENSE=projects/confidential-space-images/global/licenses/confidential-space-debug,\
    _BUCKET_NAME=${BUCKET_NAME},\
    _PRELOAD_SCRIPT=preload.sh
    exit

- name: 'gcr.io/cloud-builders/gcloud'
  id: HardenedImageBuild
  waitFor: ['BaseImageIdent', 'LauncherCompile', 'DownloadExpBinary']
  env:
  - 'OUTPUT_IMAGE_NAME=${_OUTPUT_IMAGE_PREFIX}-hardened-${_OUTPUT_IMAGE_SUFFIX}'
  - 'OUTPUT_IMAGE_FAMILY=${_OUTPUT_IMAGE_FAMILY}'
  - 'BUCKET_NAME=$_BUCKET_NAME'
  - 'SHORT_SHA=${SHORT_SHA}'
  - 'BASE_IMAGE_PROJECT=$_BASE_IMAGE_PROJECT'
  script: |
    #!/usr/bin/env bash
    set -exuo pipefail

    base_image=$(cat /workspace/base_image.txt)
    echo "building the hardened image: ${OUTPUT_IMAGE_NAME} with the base image: ${base_image}"
    gcloud builds submit --config=launcher/image/cloudbuild.yaml \
    --region us-west1 \
    --substitutions \
    _BASE_IMAGE=${base_image},\
    _BASE_IMAGE_PROJECT=${BASE_IMAGE_PROJECT},\
    _OUTPUT_IMAGE_FAMILY=${OUTPUT_IMAGE_FAMILY},\
    _OUTPUT_IMAGE_NAME=${OUTPUT_IMAGE_NAME},\
    _IMAGE_ENV=hardened,\
    _CS_LICENSE=projects/confidential-space-images/global/licenses/confidential-space,\
    _BUCKET_NAME=${BUCKET_NAME},\
    _PRELOAD_SCRIPT=preload.sh
    exit

- name: 'gcr.io/cloud-builders/gcloud'
  id: ExperimentsTests
  waitFor: ['DebugImageBuild']
  env:
  - 'OUTPUT_IMAGE_NAME=${_OUTPUT_IMAGE_PREFIX}-debug-${_OUTPUT_IMAGE_SUFFIX}'
  - 'PROJECT_ID=$PROJECT_ID'
  script: |
    #!/usr/bin/env bash

    cd launcher/image/test
    echo "running experiments client tests on ${OUTPUT_IMAGE_NAME}"
    gcloud builds submit --config=test_experiments_client.yaml --region us-west1 \
      --substitutions _IMAGE_NAME=${OUTPUT_IMAGE_NAME},_IMAGE_PROJECT=${PROJECT_ID}
    exit

- name: 'gcr.io/cloud-builders/gcloud'
  id: HttpServerTests
  waitFor: ['DebugImageBuild']
  env:
  - 'OUTPUT_IMAGE_NAME=${_OUTPUT_IMAGE_PREFIX}-debug-${_OUTPUT_IMAGE_SUFFIX}'
  - 'PROJECT_ID=$PROJECT_ID'
  script: |
    #!/usr/bin/env bash

    cd launcher/image/test
    echo "running http server tests on ${OUTPUT_IMAGE_NAME}"
    gcloud builds submit --config=test_http_server.yaml --region us-west1 \
      --substitutions _IMAGE_NAME=${OUTPUT_IMAGE_NAME},_IMAGE_PROJECT=${PROJECT_ID}
    exit

- name: 'gcr.io/cloud-builders/gcloud'
  id: DebugImageTests
  waitFor: ['DebugImageBuild']
  env:
  - 'OUTPUT_IMAGE_NAME=${_OUTPUT_IMAGE_PREFIX}-debug-${_OUTPUT_IMAGE_SUFFIX}'
  - 'PROJECT_ID=$PROJECT_ID'
  script: |
    #!/usr/bin/env bash

    cd launcher/image/test
    echo "running debug image tests on ${OUTPUT_IMAGE_NAME}"
    gcloud builds submit --config=test_debug_cloudbuild.yaml --region us-west1 \
      --substitutions _IMAGE_NAME=${OUTPUT_IMAGE_NAME},_IMAGE_PROJECT=${PROJECT_ID}
    exit

- name: 'gcr.io/cloud-builders/gcloud'
  id: DebugImageTestsTDX
  waitFor: ['DebugImageBuild']
  env:
  - 'OUTPUT_IMAGE_NAME=${_OUTPUT_IMAGE_PREFIX}-debug-${_OUTPUT_IMAGE_SUFFIX}'
  - 'PROJECT_ID=$PROJECT_ID'
  script: |
    #!/usr/bin/env bash

    cd launcher/image/test
    echo "running debug image tests on ${OUTPUT_IMAGE_NAME}"
    gcloud builds submit --config=test_debug_cloudbuild.yaml --region us-west1 \
      --substitutions _CC=TDX,_IMAGE_NAME=${OUTPUT_IMAGE_NAME},_IMAGE_PROJECT=${PROJECT_ID}
    exit

- name: 'gcr.io/cloud-builders/gcloud'
  id: HardenedImageTests
  waitFor: ['HardenedImageBuild']
  env:
  - 'OUTPUT_IMAGE_NAME=${_OUTPUT_IMAGE_PREFIX}-hardened-${_OUTPUT_IMAGE_SUFFIX}'
  - 'PROJECT_ID=$PROJECT_ID'
  script: |
    #!/usr/bin/env bash

    cd launcher/image/test
    echo "running hardened image tests on ${OUTPUT_IMAGE_NAME}"
    gcloud builds submit --config=test_hardened_cloudbuild.yaml --region us-west1 \
      --substitutions _IMAGE_NAME=${OUTPUT_IMAGE_NAME},_IMAGE_PROJECT=${PROJECT_ID}
    exit

- name: 'gcr.io/cloud-builders/gcloud'
  id: HardenedImageTestsTDX
  waitFor: ['HardenedImageBuild']
  env:
  - 'OUTPUT_IMAGE_NAME=${_OUTPUT_IMAGE_PREFIX}-hardened-${_OUTPUT_IMAGE_SUFFIX}'
  - 'PROJECT_ID=$PROJECT_ID'
  script: |
    #!/usr/bin/env bash

    cd launcher/image/test
    echo "running hardened image tests on ${OUTPUT_IMAGE_NAME}"
    gcloud builds submit --config=test_hardened_cloudbuild.yaml --region us-west1 \
      --substitutions _CC=TDX,_IMAGE_NAME=${OUTPUT_IMAGE_NAME},_IMAGE_PROJECT=${PROJECT_ID}
    exit

- name: 'gcr.io/cloud-builders/gcloud'
  id: LaunchPolicyTests
  waitFor: ['HardenedImageBuild']
  env:
  - 'OUTPUT_IMAGE_NAME=${_OUTPUT_IMAGE_PREFIX}-hardened-${_OUTPUT_IMAGE_SUFFIX}'
  - 'PROJECT_ID=$PROJECT_ID'
  script: |
    #!/usr/bin/env bash

    cd launcher/image/test
    echo "running launch policy tests on ${OUTPUT_IMAGE_NAME}"
    gcloud builds submit --config=test_launchpolicy_cloudbuild.yaml --region us-west1 \
      --substitutions _HARDENED_IMAGE_NAME=${OUTPUT_IMAGE_NAME},_IMAGE_PROJECT=${PROJECT_ID}
    exit

- name: 'gcr.io/cloud-builders/gcloud'
  id: HardenedNetworkIngressTests
  waitFor: ['HardenedImageBuild']
  env:
  - 'OUTPUT_IMAGE_NAME=${_OUTPUT_IMAGE_PREFIX}-hardened-${_OUTPUT_IMAGE_SUFFIX}'
  - 'PROJECT_ID=$PROJECT_ID'
  script: |
    #!/usr/bin/env bash
    cd launcher/image/test
    echo "running hardened image ingress network tests on ${OUTPUT_IMAGE_NAME}"
    gcloud builds submit --config=test_ingress_network.yaml --region us-west1 \
      --substitutions _IMAGE_NAME=${OUTPUT_IMAGE_NAME},_IMAGE_PROJECT=${PROJECT_ID}
    exit

- name: 'gcr.io/cloud-builders/gcloud'
  id: DebugNetworkIngressTests
  waitFor: ['DebugImageBuild']
  env:
  - 'OUTPUT_IMAGE_NAME=${_OUTPUT_IMAGE_PREFIX}-debug-${_OUTPUT_IMAGE_SUFFIX}'
  - 'PROJECT_ID=$PROJECT_ID'
  script: |
    #!/usr/bin/env bash
    cd launcher/image/test
    echo "running debug image ingress network tests on ${OUTPUT_IMAGE_NAME}"
    gcloud builds submit --config=test_ingress_network.yaml --region us-west1 \
      --substitutions _IMAGE_NAME=${OUTPUT_IMAGE_NAME},_IMAGE_PROJECT=${PROJECT_ID}
    exit

- name: 'gcr.io/cloud-builders/gcloud'
  id: LogRedirectionTests
  waitFor: ['HardenedImageBuild']
  env:
  - 'OUTPUT_IMAGE_NAME=${_OUTPUT_IMAGE_PREFIX}-hardened-${_OUTPUT_IMAGE_SUFFIX}'
  - 'PROJECT_ID=$PROJECT_ID'
  script: |
    #!/usr/bin/env bash

    cd launcher/image/test
    echo "running log redirection tests on ${OUTPUT_IMAGE_NAME}"
    gcloud builds submit --config=test_log_redirection.yaml --region us-west1 \
      --substitutions _HARDENED_IMAGE_NAME=${OUTPUT_IMAGE_NAME},_IMAGE_PROJECT=${PROJECT_ID}
    exit

- name: 'gcr.io/cloud-builders/gcloud'
  id: HardenedDiscoverContainerSignatureTests
  waitFor: ['HardenedImageBuild']
  env:
  - 'OUTPUT_IMAGE_NAME=${_OUTPUT_IMAGE_PREFIX}-hardened-${_OUTPUT_IMAGE_SUFFIX}'
  - 'PROJECT_ID=$PROJECT_ID'
  script: |
    #!/usr/bin/env bash
    cd launcher/image/test
    echo "running hardened image container signature tests on ${OUTPUT_IMAGE_NAME}"
    gcloud builds submit --config=test_discover_signatures.yaml --region us-west1 \
      --substitutions _IMAGE_NAME=${OUTPUT_IMAGE_NAME},_IMAGE_PROJECT=${PROJECT_ID},_SIGNATURE_REPO=us-docker.pkg.dev/confidential-space-images-dev/cs-cosign-tests/hardened
    exit

- name: 'gcr.io/cloud-builders/gcloud'
  id: DebugDiscoverContainerSignatureTests
  waitFor: ['DebugImageBuild']
  env:
  - 'OUTPUT_IMAGE_NAME=${_OUTPUT_IMAGE_PREFIX}-debug-${_OUTPUT_IMAGE_SUFFIX}'
  - 'PROJECT_ID=$PROJECT_ID'
  script: |
    #!/usr/bin/env bash
    cd launcher/image/test
    echo "running debug image container signature tests on ${OUTPUT_IMAGE_NAME}"
    gcloud builds submit --config=test_discover_signatures.yaml --region us-west1 \
      --substitutions _IMAGE_NAME=${OUTPUT_IMAGE_NAME},_IMAGE_PROJECT=${PROJECT_ID},_SIGNATURE_REPO=us-docker.pkg.dev/confidential-space-images-dev/cs-cosign-tests/debug
    exit

- name: 'gcr.io/cloud-builders/gcloud'
  id: MemoryMonitoringTests
  waitFor: ['HardenedImageBuild']
  env:
  - 'OUTPUT_IMAGE_NAME=${_OUTPUT_IMAGE_PREFIX}-hardened-${_OUTPUT_IMAGE_SUFFIX}'
  - 'PROJECT_ID=$PROJECT_ID'
  script: |
    #!/usr/bin/env bash
    cd launcher/image/test
    echo "running memory monitoring tests on ${OUTPUT_IMAGE_NAME}"
    gcloud builds submit --config=test_memory_monitoring.yaml --region us-west1 \
      --substitutions _IMAGE_NAME=${OUTPUT_IMAGE_NAME},_IMAGE_PROJECT=${PROJECT_ID}
    exit

- name: 'gcr.io/cloud-builders/gcloud'
  id: HealthMonitoringTests
  waitFor: ['HardenedImageBuild']
  env:
  - 'OUTPUT_IMAGE_NAME=${_OUTPUT_IMAGE_PREFIX}-hardened-${_OUTPUT_IMAGE_SUFFIX}'
  - 'PROJECT_ID=$PROJECT_ID'
  script: |
    #!/usr/bin/env bash
    cd launcher/image/test
    echo "running health monitoring tests on ${OUTPUT_IMAGE_NAME}"
    gcloud builds submit --config=test_health_monitoring.yaml --region us-west1 \
      --substitutions _IMAGE_NAME=${OUTPUT_IMAGE_NAME},_IMAGE_PROJECT=${PROJECT_ID}
    exit

- name: 'gcr.io/cloud-builders/gcloud'
  id: ODAWithSignedContainerTest
  waitFor: ['HardenedImageBuild']
  env:
  - 'OUTPUT_IMAGE_NAME=${_OUTPUT_IMAGE_PREFIX}-hardened-${_OUTPUT_IMAGE_SUFFIX}'
  - 'PROJECT_ID=$PROJECT_ID'
  script: |
    #!/usr/bin/env bash
    cd launcher/image/test
    echo "running ODA and signed container tests on ${OUTPUT_IMAGE_NAME}"
    gcloud builds submit --config=test_oda_with_signed_container.yaml --region us-west1 \
      --substitutions _IMAGE_NAME=${OUTPUT_IMAGE_NAME},_IMAGE_PROJECT=${PROJECT_ID}
    exit

- name: 'gcr.io/cloud-builders/gcloud'
  id: MountTests
  waitFor: ['HardenedImageBuild']
  env:
  - 'OUTPUT_IMAGE_NAME=${_OUTPUT_IMAGE_PREFIX}-hardened-${_OUTPUT_IMAGE_SUFFIX}'
  - 'PROJECT_ID=$PROJECT_ID'
  script: |
    #!/usr/bin/env bash
    cd launcher/image/test
    dev_shm_size_kb=$(shuf -i 70000-256000 -n 1)
    tmpfs_size_kb=$(shuf -i 256-256000 -n 1)
    echo "running mount tests on ${OUTPUT_IMAGE_NAME}"
    gcloud builds submit --config=test_mounts.yaml --region us-west1 \
      --substitutions _IMAGE_NAME=${OUTPUT_IMAGE_NAME},_IMAGE_PROJECT=${PROJECT_ID}
    exit

- name: 'gcr.io/cloud-builders/gcloud'
  id: PrivilegedTests
  waitFor: ['HardenedImageBuild']
  env:
  - 'OUTPUT_IMAGE_NAME=${_OUTPUT_IMAGE_PREFIX}-hardened-${_OUTPUT_IMAGE_SUFFIX}'
  - 'PROJECT_ID=$PROJECT_ID'
  script: |
    #!/usr/bin/env bash
    cd launcher/image/test
    echo "running privileged tests on ${OUTPUT_IMAGE_NAME}"
    gcloud builds submit --config=test_privileged.yaml --region us-west1 \
      --substitutions _IMAGE_NAME=${OUTPUT_IMAGE_NAME},_IMAGE_PROJECT=${PROJECT_ID}
    exit

- name: 'gcr.io/cloud-builders/gcloud'
  id: ExportHardenedImage
  waitFor: ['HardenedImageTests']
  entrypoint: 'gcloud'
  args: ['compute', 'images', 'export',
         '--destination-uri=gs://${PROJECT_ID}_raw-images/${_OUTPUT_IMAGE_PREFIX}-hardened-${_OUTPUT_IMAGE_SUFFIX}.tar.gz',
         '--image=${_OUTPUT_IMAGE_PREFIX}-hardened-${_OUTPUT_IMAGE_SUFFIX}',
         '--project=${PROJECT_ID}']

- name: 'gcr.io/cloud-builders/gcloud'
  id: ExportDebugImage
  waitFor: ['DebugImageTests']
  entrypoint: 'gcloud'
  args: ['compute', 'images', 'export',
          '--destination-uri=gs://${PROJECT_ID}_raw-images/${_OUTPUT_IMAGE_PREFIX}-debug-${_OUTPUT_IMAGE_SUFFIX}.tar.gz',
          '--image=${_OUTPUT_IMAGE_PREFIX}-debug-${_OUTPUT_IMAGE_SUFFIX}',
          '--project=${PROJECT_ID}']

- name: 'us-docker.pkg.dev/confidential-space-images-dev/cs-tools/measure@sha256:b82c8ca459b863cfdf9faf8e4c06d506a50f3fe86ca1f3756ca6fee42a5cd7f4'
  id: MeasureHardenedImage
  waitFor: ['ExportHardenedImage']
  env:
  - 'OUTPUT_IMAGE_NAME=${_OUTPUT_IMAGE_PREFIX}-hardened-${_OUTPUT_IMAGE_SUFFIX}'
  - 'PROJECT_ID=$PROJECT_ID'
  script: |
    #!/usr/bin/env bash
    echo "downloading hardened image ${OUTPUT_IMAGE_NAME}"
    gcloud storage cp gs://confidential-space-images-dev_raw-images/${OUTPUT_IMAGE_NAME}.tar.gz .
    mkdir hardeneddisk
    tar xzf ${OUTPUT_IMAGE_NAME}.tar.gz -C hardeneddisk/
    echo "measuring image ${OUTPUT_IMAGE_NAME}"
    /usr/local/bin/measure.sh hardeneddisk/disk.raw measure_output_hardened.json hardened x86_64
    cat measure_output_hardened.json
    gcloud storage cp measure_output_hardened.json gs://${PROJECT_ID}-rims/${OUTPUT_IMAGE_NAME}.json

- name: 'us-docker.pkg.dev/confidential-space-images-dev/cs-tools/measure@sha256:b82c8ca459b863cfdf9faf8e4c06d506a50f3fe86ca1f3756ca6fee42a5cd7f4'
  id: MeasureDebugImage
  waitFor: ['ExportDebugImage']
  env:
  - 'OUTPUT_IMAGE_NAME=${_OUTPUT_IMAGE_PREFIX}-debug-${_OUTPUT_IMAGE_SUFFIX}'
  - 'PROJECT_ID=$PROJECT_ID'
  script: |
    #!/usr/bin/env bash
    echo "downloading debug image ${OUTPUT_IMAGE_NAME}"
    gsutil cp gs://confidential-space-images-dev_raw-images/${OUTPUT_IMAGE_NAME}.tar.gz .
    mkdir debugdisk
    tar xzf ${OUTPUT_IMAGE_NAME}.tar.gz -C debugdisk/
    echo "measuring image ${OUTPUT_IMAGE_NAME}"
    /usr/local/bin/measure.sh debugdisk/disk.raw measure_output_debug.json debug x86_64
    cat measure_output_debug.json
    gsutil cp measure_output_debug.json gs://${PROJECT_ID}-rims/${OUTPUT_IMAGE_NAME}.json

- name: 'gcr.io/cloud-builders/gcloud'
  id: ExportVgHardenedImage
  waitFor: ['HardenedVgImageBuild']
  entrypoint: 'gcloud'
  args: ['compute', 'images', 'export',
         '--destination-uri=gs://${PROJECT_ID}_raw-images/${_OUTPUT_IMAGE_PREFIX}-vg-hardened-${_OUTPUT_IMAGE_SUFFIX}.tar.gz',
         '--image=${_OUTPUT_IMAGE_PREFIX}-vg-hardened-${_OUTPUT_IMAGE_SUFFIX}',
         '--project=${PROJECT_ID}']

- name: 'gcr.io/cloud-builders/gcloud'
  id: ExportVgDebugImage
  waitFor: ['DebugVgImageBuild']
  entrypoint: 'gcloud'
  args: ['compute', 'images', 'export',
          '--destination-uri=gs://${PROJECT_ID}_raw-images/${_OUTPUT_IMAGE_PREFIX}-vg-debug-${_OUTPUT_IMAGE_SUFFIX}.tar.gz',
          '--image=${_OUTPUT_IMAGE_PREFIX}-vg-debug-${_OUTPUT_IMAGE_SUFFIX}',
          '--project=${PROJECT_ID}']

- name: 'us-docker.pkg.dev/confidential-space-images-dev/cs-tools/measure@sha256:b82c8ca459b863cfdf9faf8e4c06d506a50f3fe86ca1f3756ca6fee42a5cd7f4'
  id: MeasureVgHardenedImage
  waitFor: ['ExportVgHardenedImage']
  env:
  - 'OUTPUT_IMAGE_NAME=${_OUTPUT_IMAGE_PREFIX}-vg-hardened-${_OUTPUT_IMAGE_SUFFIX}'
  - 'PROJECT_ID=$PROJECT_ID'
  script: |
    #!/usr/bin/env bash
    echo "downloading hardened image ${OUTPUT_IMAGE_NAME}"
    gcloud storage cp gs://confidential-space-images-dev_raw-images/${OUTPUT_IMAGE_NAME}.tar.gz .
    mkdir vghardeneddisk
    tar xzf ${OUTPUT_IMAGE_NAME}.tar.gz -C vghardeneddisk/
    echo "measuring image ${OUTPUT_IMAGE_NAME}"
    /usr/local/bin/measure.sh vghardeneddisk/disk.raw measure_output_vg_hardened.json hardened x86_64
    cat measure_output_hardened.json
    gcloud storage cp measure_output_vg_hardened.json gs://${PROJECT_ID}-rims/${OUTPUT_IMAGE_NAME}.json

- name: 'us-docker.pkg.dev/confidential-space-images-dev/cs-tools/measure@sha256:b82c8ca459b863cfdf9faf8e4c06d506a50f3fe86ca1f3756ca6fee42a5cd7f4'
  id: MeasureVgDebugImage
  waitFor: ['ExportVgDebugImage']
  env:
  - 'OUTPUT_IMAGE_NAME=${_OUTPUT_IMAGE_PREFIX}-vg-debug-${_OUTPUT_IMAGE_SUFFIX}'
  - 'PROJECT_ID=$PROJECT_ID'
  script: |
    #!/usr/bin/env bash
    echo "downloading debug image ${OUTPUT_IMAGE_NAME}"
    gsutil cp gs://confidential-space-images-dev_raw-images/${OUTPUT_IMAGE_NAME}.tar.gz .
    mkdir vgdebugdisk
    tar xzf ${OUTPUT_IMAGE_NAME}.tar.gz -C vgdebugdisk/
    echo "measuring image ${OUTPUT_IMAGE_NAME}"
    /usr/local/bin/measure.sh vgdebugdisk/disk.raw measure_output_vg_debug.json debug x86_64
    cat measure_output_debug.json
    gsutil cp measure_output_vg_debug.json gs://${PROJECT_ID}-rims/${OUTPUT_IMAGE_NAME}.json

options:
  pool:
    name: 'projects/confidential-space-images-dev/locations/us-west1/workerPools/cs-image-build-vpc'
